<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layouts/admin_layout}">
<head>
  <title>Quản lý Người dùng</title>
</head>
<body>

<th:block layout:fragment="content">

  <div class="card admin-card p-4">
    <h5 class="section-title mb-4">Danh sách Tài khoản Hệ thống</h5>

    <div id="alert-success" class="alert alert-success" style="display: none;"></div>
    <div id="alert-error" class="alert alert-danger" style="display: none;"></div>

    <div th:if="${usersPage.hasContent()}" class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-dark">
        <tr>
          <th>ID</th>
          <th>Tên hiển thị</th>
          <th>Username</th>
          <th>Email</th>
          <th>Vai trò</th>
          <th>Trạng thái</th>
          <th>Ngày tham gia</th>
          <th>Hành động</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="user : ${usersPage.content}">
          <td th:text="${user.id}">1</td>
          <td th:text="${user.fullName}">Nguyễn Văn A</td>
          <td th:text="${user.username}">nguyenvana</td>
          <td th:text="${user.email}">a@ptit.edu.vn</td>
          <td>
                            <span th:each="role : ${user.roles}"
                                  th:text="${role.replace('ROLE_', '')}"
                                  th:classappend="${role == 'ROLE_ADMIN' ? 'badge bg-danger' : 'badge bg-secondary'}"
                                  class="me-1">
                            </span>
          </td>
          <td>
            <span th:if="${user.isEnabled}" class="badge bg-success">Hoạt động</span>
            <span th:unless="${user.isEnabled}" class="badge bg-secondary">Vô hiệu hóa</span>
          </td>
          <td>
            <span th:text="${#dates.format(user.createdAt, 'dd/MM/yyyy')}">...</span>
          </td>
          <td>
            <button th:if="${user.isEnabled}"
                    class="btn btn-warning btn-sm"
                    th:onclick="|disableUser('${user.id}', '${user.username}')|">
              <i class="fas fa-user-slash"></i> Vô hiệu hóa
            </button>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <div th:unless="${usersPage.hasContent()}" class="alert alert-info text-center mb-0">
      <i class="fas fa-info-circle me-2"></i> Không tìm thấy người dùng nào.
    </div>
  </div>
  </th-block>

  <th-block layout:fragment="scripts">
    <script>
      // Hàm xử lý Vô hiệu hóa User
      function disableUser(userId, username) {

        // Lấy username của admin đang đăng nhập (để ngăn tự xóa)
        const currentAdminUsername = '[[${#authentication.name}]]';
        if (username === currentAdminUsername) {
          alert('Không thể vô hiệu hóa tài khoản quản trị đang đăng nhập!');
          return;
        }

        if (!confirm(`Bạn có chắc chắn muốn VÔ HIỆU HÓA tài khoản '${username}' không?`)) {
          return;
        }

        // GỌI ĐÚNG API: DELETE /api/admin/users/{id}
        fetch(`/api/admin/users/${userId}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            // 'X-CSRF-TOKEN': token
          }
        })
                .then(response => {
                  if (response.ok) {
                    alert('Vô hiệu hóa tài khoản thành công!');
                    window.location.reload();
                  } else {
                    response.json().then(data => alert('Lỗi: ' + (data.message || 'Lỗi server.')));
                  }
                })
                .catch(error => {
                  console.error('Lỗi Vô hiệu hóa User:', error);
                  alert('Lỗi kết nối máy chủ.');
                });
      }
    </script>
  </th-block>

</body>
</html>